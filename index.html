<!doctype html>
<html lang="th" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#22d3ee" id="metaTheme" />
  <title>GmailSP • ประวัติ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+Thai:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#eef7ff;--ink:#0f172a;--muted:#64748b;--card:#ffffff;--ring:rgba(2,6,23,.12);--ring-strong:rgba(2,6,23,.18);--gradA:#22d3ee;--gradB:#a78bfa;--accent:#06b6d4;--ok:#16a34a;--bad:#ef4444;--unk:#eab308;--radius:16px;--radius-lg:20px;--shadow:0 12px 34px rgba(2,6,23,.12);--shadow-sm:0 2px 10px rgba(2,6,23,.08);--safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom);--mark-bg:#fffbcc;--mark-ink:#0f172a;--topbar-h:64px}
    [data-theme="dark"]{--bg:#0b1220;--ink:#e6f1ff;--muted:#9fb0c3;--card:#0f172a;--ring:rgba(148,163,184,.24);--ring-strong:rgba(148,163,184,.32);--gradA:#38bdf8;--gradB:#8b5cf6;--accent:#38bdf8;--ok:#22c55e;--bad:#f87171;--unk:#facc15;--shadow:0 16px 40px rgba(2,6,23,.40);--shadow-sm:0 2px 10px rgba(2,6,23,.35);--mark-bg:#3b82f6;--mark-ink:#ffffff}
    *{box-sizing:border-box;min-width:0}
    html,body{height:100%;overflow-x:hidden;scroll-behavior:smooth}
    body{margin:0;color:var(--ink);font-family:'Inter','Noto Sans Thai',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;position:relative;background:linear-gradient(180deg,color-mix(in lab,var(--bg) 94%,#fff),var(--bg));}
    body::before{content:"";position:fixed;inset:-20% -20% -10% -20%;pointer-events:none;z-index:-1;filter:blur(42px) saturate(140%);opacity:.7;mix-blend-mode:plus-lighter;background:
      radial-gradient(60% 40% at 15% 10%,color-mix(in oklab,var(--gradA) 22%,transparent),transparent 60%),
      radial-gradient(50% 35% at 85% 5%,color-mix(in oklab,var(--gradB) 24%,transparent),transparent 60%),
      radial-gradient(40% 30% at 70% 70%,color-mix(in oklab,var(--accent) 18%,transparent),transparent 60%);
      animation:float 16s ease-in-out infinite alternate}
    [data-theme="dark"] body::before{opacity:.5}
    @keyframes float{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(-2%,2%,0)}}

    .bounds{max-width:980px;margin-inline:auto}

    .topbar{position:sticky;top:0;z-index:50;box-shadow:0 1px 0 rgba(255,255,255,.22)}
    .topbar-inner{display:flex;align-items:center;gap:10px;padding:calc(10px + var(--safe-top)) 14px 10px;background:linear-gradient(90deg,var(--gradA),var(--gradB));color:#fff}
    .brand{display:flex;gap:10px;align-items:center}
    .badge{width:34px;height:34px;border-radius:10px;background:rgba(255,255,255,.22);backdrop-filter:saturate(180%) blur(6px);display:grid;place-items:center;font-weight:900}
    .title{font-size:16px;font-weight:900;letter-spacing:.2px}
    .sub{font-size:11px;opacity:.9}
    .spacer{flex:1}
    .iconbtn{appearance:none;border:0;background:rgba(255,255,255,.20);color:#fff;width:40px;height:40px;border-radius:12px;display:grid;place-items:center;transition:transform .12s ease}
    .iconbtn:active{transform:scale(.94)}

    .toolbar{position:sticky;top:var(--topbar-h);z-index:40;background:color-mix(in lab,var(--card) 92%,transparent);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--ring)}
    .toolbar-inner{padding:10px 10px;display:flex;align-items:center}
    .filters{display:flex;align-items:center;gap:8px;overflow:auto;padding-bottom:2px;width:100%;flex-wrap:nowrap;white-space:nowrap}
    .filters::-webkit-scrollbar{display:none}
    .chip{padding:7px 10px;border-radius:999px;border:1px solid var(--ring);background:var(--card);font-size:12px;display:inline-flex;align-items:center;gap:8px;box-shadow:var(--shadow-sm);line-height:1.4}
    .chip b{font-weight:800;line-height:1}
    .chip .dot{width:9px;height:9px;border-radius:999px;background:#cbd5e1;flex:0 0 auto}
    .chip.ok .dot{background:var(--ok)}.chip.unk .dot{background:var(--unk)}

    .wrap{padding:12px 12px calc(110px + var(--safe-bottom));display:grid;gap:12px;contain:layout paint style;max-width:980px;margin-inline:auto}

    .day{align-self:start;display:inline-flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--ring);border-radius:999px;padding:8px 12px;box-shadow:var(--shadow-sm);content-visibility:auto;contain-intrinsic-size:24px 160px}
    .dot-day{width:8px;height:8px;border-radius:999px;background:var(--accent)}

    .event{position:relative;display:grid;grid-template-columns:44px 1fr;gap:10px;align-items:start;padding:12px;border-radius:var(--radius-lg);background:var(--card);border:1px solid var(--ring);box-shadow:var(--shadow);transform:translateZ(0);transition:transform .12s ease,box-shadow .12s ease;will-change:transform;content-visibility:auto;contain-intrinsic-size:78px 320px}
    .event:active{transform:scale(.995)}
    .ev-del{position:absolute;top:8px;right:8px;appearance:none;border:0;background:transparent;font-size:18px;line-height:1;opacity:.8;cursor:pointer}
    .ev-del:hover{opacity:1}
    .avatar{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(180deg,#e0f2fe,#f5f3ff);border:1px solid var(--ring)}
    [data-theme="dark"] .avatar{background:linear-gradient(180deg,#0b1a35,#1b133a)}
    .email{font-weight:900;font-size:16px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .time{font-size:12px;color:var(--muted)}

    .note{font-size:14px;color:color-mix(in lab,var(--ink) 90%,var(--muted));background:color-mix(in lab,var(--gradA) 7%,var(--card));border:1px solid var(--ring);padding:10px 12px;border-radius:12px;line-height:1.45;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;outline:none;transition:box-shadow .12s ease,background .12s ease}
    .note.editing{white-space:normal;box-shadow:0 0 0 3px color-mix(in lab,var(--gradA) 26%,transparent)}
    .note.empty{opacity:.8;font-style:italic}

    .badge-app{display:inline-flex;align-items:center;gap:6px;padding:6px 9px;border-radius:999px;border:1px solid var(--ring);background:var(--card);font-size:12px;box-shadow:var(--shadow-sm);cursor:pointer;will-change:transform}
    .i{width:16px;height:16px;display:inline-block}
    .S{color:#ee4d2d}.G{color:#0ea5e9}.C{color:#7c3aed}.T{color:#111111}
    .unk{color:var(--unk)}.ok{color:var(--ok)}.bad{color:var(--bad)}

    .fab{position:fixed;right:16px;bottom:calc(18px + var(--safe-bottom));width:60px;height:60px;border-radius:20px;display:grid;place-items:center;color:#003041;background:linear-gradient(160deg,var(--gradA),var(--gradB));box-shadow:var(--shadow);border:0;transition:transform .12s ease}
    .fab:active{transform:scale(.96)}

    dialog.sheet{border:0;padding:0;background:transparent}
    .sheet::backdrop{background:rgba(2,6,23,.25);backdrop-filter:blur(3px)}
    .panel{width:100%;max-height:85vh;background:var(--card);border:1px solid var(--ring-strong);border-radius:22px 22px 0 0;position:fixed;left:0;right:0;bottom:0;box-shadow:var(--shadow);transform:translate3d(0,100%,0);transition:transform .33s cubic-bezier(.22,.95,.19,1)}
    dialog[open] .panel{transform:translate3d(0,0,0)}
    .grab{width:44px;height:5px;border-radius:999px;background:#cbd5e1;margin:10px auto}
    [data-theme="dark"] .grab{background:#334155}
    .form{padding:6px 14px 14px;display:grid;gap:12px}
    .label{font-size:12px;color:var(--muted)}
    .input,.textarea{width:100%;background:var(--card);border:1px solid var(--ring);border-radius:14px;color:var(--ink);padding:12px;font-size:16px;outline:none}
    .textarea{min-height:80px;resize:vertical}
    .status-row{display:flex;gap:8px;flex-wrap:wrap}
    .status-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:var(--card);border:1px solid var(--ring);font-size:13px;box-shadow:var(--shadow-sm)}
    .status-btn:active{transform:scale(.96)}
    .status-dot{width:9px;height:9px;border-radius:999px;background:#cbd5e1}
    .status-used .status-dot{background:var(--ok)}
    .status-unknown .status-dot{background:var(--unk)}

    .row{display:flex;gap:10px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:800}
    .btn.primary{background:linear-gradient(160deg,var(--gradA),var(--gradB));color:#00222e}
    .btn.ghost{background:var(--card);border:1px solid var(--ring);color:var(--ink)}
    .btn.danger{background:linear-gradient(160deg,#fca5a5,#ef4444);color:#2a0a0a}
    .btn.more{display:none;margin:8px auto 24px}
    .btn.more.show{display:block}

    .skeleton{height:78px;border-radius:var(--radius-lg);background:linear-gradient(90deg,rgba(2,6,23,.04),rgba(2,6,23,.12),rgba(2,6,23,.04));background-size:200% 100%;animation:shimmer .9s linear infinite;border:1px solid var(--ring)}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

    .empty{margin:16vh 16px 0;text-align:center;color:var(--muted)}
    .empty h2{margin:0 0 6px;font-size:18px;color:var(--ink)}
    .empty p{margin:0}

    .toastwrap{position:fixed;inset:auto 0 calc(110px + var(--safe-bottom)) 0;display:grid;place-items:center;pointer-events:none}
    .toast{background:#0f172a;color:#fff;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:10px 14px;box-shadow:var(--shadow-sm);opacity:0;transform:translateY(10px);transition:transform .2s ease,opacity .2s ease}
    .toast.show{opacity:1;transform:translateY(0)}

    @media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner bounds">
      <div class="brand">
        <div class="badge">SP</div>
        <div><div class="title">ประวัติอีเมล</div><div class="sub">รายการล่าสุด</div></div>
      </div>
      <div class="spacer"></div>
      <button id="btnTheme" class="iconbtn" aria-label="สลับธีม" title="สลับธีม">🌗</button>
      <button id="btnRefresh" class="iconbtn" aria-label="รีเฟรช" title="รีเฟรช">⟳</button>
    </div>
  </header>

  <div class="toolbar">
    <div class="toolbar-inner bounds">
      <div class="filters" id="filterChips"></div>
    </div>
  </div>

  <main class="wrap" id="timeline" role="feed" aria-busy="true"></main>
  <div id="io-sentinel" style="height:1px"></div>
  <button id="btnMore" class="btn ghost more">โหลดเพิ่ม</button>

  <dialog class="sheet" id="addSheet">
    <div class="panel" role="dialog" aria-labelledby="addTitle">
      <div class="grab"></div>
      <form class="form" id="addForm">
        <div id="addTitle" style="font-weight:900;font-size:18px">เพิ่มอีเมลใหม่</div>
        <div>
          <div class="label">ชื่อผู้ใช้ (ระบบจะต่อ @gmail.com ให้อัตโนมัติ)</div>
          <input id="addLocal" class="input" type="text" placeholder="เช่น myaccount" autocomplete="off" required />
        </div>
        <div>
          <div class="label">หมายเหตุ</div>
          <textarea id="addNote" class="textarea" placeholder="เช่น สมัคร Shopee แล้ว / รอ OTP"></textarea>
        </div>
        <div>
          <div class="label">สถานะแต่ละแอป (แตะเพื่อสลับ)</div>
          <div class="status-row" id="addStatuses"></div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button type="button" class="btn ghost" id="btnCancelAdd">ยกเลิก</button>
          <button type="submit" class="btn primary">บันทึก</button>
        </div>
      </form>
    </div>
  </dialog>

  <button id="btnAdd" class="fab" aria-label="เพิ่ม">＋</button>
  <div class="toastwrap"><div id="toast" class="toast"></div></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  (function(){
    'use strict';
    const SUPABASE_URL='https://tuyttwketzbewvqqqdum.supabase.co';
    const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1eXR0d2tldHpiZXd2cXFxZHVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxODM4MDAsImV4cCI6MjA2ODc1OTgwMH0.3S9meIoh6ULCH2L4-R_wzud2rw70U8lJzs4gj9028fY';
    const db=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
    const TABLE='email_usage';

    const $=(s,p=document)=>p.querySelector(s);
    const $$=(s,p=document)=>Array.from(p.querySelectorAll(s));
    const on=(el,ev,fn,opts)=>el&&el.addEventListener(ev,fn,opts);
    const toast=t=>{const el=$('#toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1600)};

    const metaTheme=document.getElementById('metaTheme');
    const THEME_KEY='gmailsp_theme';
    function applyTheme(mode){const root=document.documentElement;root.setAttribute('data-theme',mode);metaTheme.setAttribute('content',mode==='dark'?'#0b1220':'#22d3ee');localStorage.setItem(THEME_KEY,mode)}
    function initTheme(){const saved=localStorage.getItem(THEME_KEY);const prefersDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;applyTheme(saved||(prefersDark?'dark':'light'))}

    const state={page:0,size:40,loading:false,lastDayKey:null,total:0,filters:{shopee:'all',gemini:'all',chatgpt:'all',tiktok:'all',hasNote:false},rowsById:{}};

    const escapeHtml=s=>String(s??'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const statusText={used:'ใช้งานแล้ว',unknown:'ไม่ทราบสถานะ',unusable:'ใช้งานไม่ได้'};
    const apps=[{k:'shopee',n:'Shopee',cls:'S'},{k:'gemini',n:'Gemini',cls:'G'},{k:'chatgpt',n:'ChatGPT',cls:'C'},{k:'tiktok',n:'TikTok',cls:'T'}];
    const icons={S:'<svg class="i S" viewBox="0 0 24 24" fill="currentColor"><path d="M7 7V6a5 5 0 0 1 10 0v1h2a1 1 0  0 1 1 1v10.5A2.5 2.5 0 0 1 17.5 21h-11A2.5 2.5 0 0 1 4 18.5V8a1 1 0  0 1 1-1h2zm2 0h6V6a3 3 0 1 0-6 0v1z"/></svg>',G:'<svg class="i G" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l2.2 4.6L19 8.3l-3.5 3.4.8 4.9L12 14.8 7.7 16.6l.8-4.9L5 8.3l4.8-.7L12 3z"/></svg>',C:'<svg class="i C" viewBox="0 0 24 24" fill="currentColor"><path d="M21 15a4 4 0  0 1-4 4H8l-5 2V7a4 4 0  0 1 4-4h6a4 4 0 0 1 4 4v1a4 4 0  0 1 4 4v3z"/></svg>',T:'<svg class="i T" viewBox="0 0 24 24" fill="currentColor"><path d="M17 2v5.1a5.9 5.9 0 0 1-3-1V14a5 5 0 1 1-5-5 4.9 4.9 0  0 1 1 .1V6.2A8.9 8.9 0 0 0 8 6a8 8 0 1 0 9 8V8.5a7 7 0  0  0 3 1V6a6 6 0 0 1-3-4z"/></svg>'};
    const tone=v=>v==='used'?'ok':(v==='unusable'?'bad':'unk');

    const NOTE_MAX=500;
    const ALLOWED_APPS=['shopee','gemini','chatgpt','tiktok'];
    const STATUS_CYCLE=['used','unknown','unusable'];

    const OV_KEY='gmailsp_ui_overrides';
    const overrides=loadOverrides();
    function loadOverrides(){try{return JSON.parse(localStorage.getItem(OV_KEY)||'{}')}catch{return {}}}
    function saveOverrides(){try{localStorage.setItem(OV_KEY,JSON.stringify(overrides))}catch{}}
    const ovK=(id,app)=>`${id}::${app}`;
    const getOverride=(id,app)=>overrides[ovK(id,app)];
    const setOverride=(id,app,val)=>{if(val)overrides[ovK(id,app)]=val;else delete overrides[ovK(id,app)];saveOverrides()};

    const elTimeline=$('#timeline');
    const elFilterChips=$('#filterChips');
    const elBtnMore=$('#btnMore');

    const dayKeyFrom=iso=>{const d=new Date(iso||Date.now());return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`};
    function dayLabel(key){try{const [y,m,d]=key.split('-').map(Number);const dt=new Date(y,m-1,d);const today=new Date();today.setHours(0,0,0,0);const that=new Date(+dt);that.setHours(0,0,0,0);const diff=(that-today)/86400000;if(diff===0)return'วันนี้';if(diff===-1)return'เมื่อวาน';return dt.toLocaleDateString('th-TH',{day:'numeric',month:'short',year:'numeric'})}catch(e){return key}}
    const dayHeaderHTML=key=>`<div class="day" id="day-${key}"><span class="dot-day"></span><b>${dayLabel(key)}</b></div>`;

    function effectiveStatus(id,app,dbVal){const ov=getOverride(id,app);if(ov)return ov;const v=String(dbVal||'').toLowerCase();if(v==='unused')return 'unknown';return STATUS_CYCLE.includes(v)?v:'unknown'}
    function buildBadgeHTML(appKey,val,id){const app=apps.find(a=>a.k===appKey);const v=STATUS_CYCLE.includes(val)?val:'unknown';return `${icons[app.cls]} <b>${app.n}</b> · ${statusText[v]}`}
    function renderBadgeEl(appKey,val,id){const showVal=effectiveStatus(id,appKey,val);return `<button type="button" class="badge-app ${tone(showVal)}" data-id="${id}" data-app="${appKey}" data-val="${showVal}">${buildBadgeHTML(appKey,showVal,id)}</button>`}

    function eventItem(row){const id=String(row.id);const email=escapeHtml(String(row.email||''));const noteStr=String(row.note||'');const time=new Date(row.created_at||Date.now()).toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'});return `<article class="event" data-id="${escapeHtml(id)}"><button class="ev-del" data-id="${escapeHtml(id)}" title="ลบรายการ">✕</button><div class="avatar">＠</div><div><div class="email" title="${email}">${email}</div><div class="meta">${renderBadgeEl('shopee',row.shopee,id)}${renderBadgeEl('gemini',row.gemini,id)}${renderBadgeEl('chatgpt',row.chatgpt,id)}${renderBadgeEl('tiktok',row.tiktok,id)}<span class="time">· ${time}</span></div><div class="note ${noteStr?'':'empty'}" data-id="${escapeHtml(id)}" contenteditable="true" spellcheck="false" title="แตะเพื่อแก้ไขหมายเหตุ">${escapeHtml(noteStr||'— ไม่มีหมายเหตุ —')}</div></div></article>`}

    function renderFilterChips(){const map=[{k:'shopee',label:'Shopee'},{k:'gemini',label:'Gemini'},{k:'chatgpt',label:'ChatGPT'},{k:'tiktok',label:'TikTok'}];elFilterChips.innerHTML='';const cycle=['all','used','unknown'];for(const it of map){const v=state.filters[it.k];const cls=v==='used'?'ok':(v==='unknown'?'unk':'');const chip=document.createElement('button');chip.className=`chip ${cls}`;chip.dataset.key=it.k;chip.dataset.value=v;chip.innerHTML=`<span class="dot"></span><b>${it.label}</b> ${(v==='all')?'ทั้งหมด':statusText[v]}`;on(chip,'click',()=>{const i=cycle.indexOf(state.filters[it.k]||'all');const nxt=cycle[(i+1)%cycle.length];for(const k of ['shopee','gemini','chatgpt','tiktok']){state.filters[k]=(k===it.k)?nxt:'all'}renderFilterChips();render(true).then(()=>autofill())});elFilterChips.appendChild(chip)}const noteChip=document.createElement('button');noteChip.className='chip';noteChip.dataset.key='hasNote';noteChip.innerHTML=`📝 <b>มีหมายเหตุ</b> ${state.filters.hasNote?'✓':''}`;on(noteChip,'click',()=>{state.filters.hasNote=!state.filters.hasNote;renderFilterChips();render(true).then(()=>autofill())});elFilterChips.appendChild(noteChip)}

    function errString(e){try{if(!e)return 'Unknown error';if(typeof e==='string')return e||'Unknown error';const m=e.message||e.msg||'';const d=e.details||e.detail||'';const h=e.hint||'';const c=e.code||'';const parts=[m,d,h,c].filter(Boolean);if(parts.length)return parts.join(' | ');const s=JSON.stringify(e);return s&&s!=='{}'?s:String(e)}catch(_){try{return String(e)}catch{return 'Unknown error'}}}

    function coerceId(v){const s=String(v);return /^\d+$/.test(s)?Number(s):s}

    async function fetchPage(){let q=db.from(TABLE).select('id,email,note,shopee,gemini,chatgpt,tiktok,created_at',{count:'exact'});
      for(const key of ['shopee','gemini','chatgpt','tiktok']){const v=state.filters[key];if(v==='used')q=q.eq(key,'used');if(v==='unknown')q=q.in(key,['unknown','unused'])}
      if(state.filters.hasNote)q=q.not('note','is',null).neq('note','');
      q=q.order('created_at',{ascending:false}).order('id',{ascending:false});
      const from=state.page*state.size,to=from+state.size-1;const {data,count,error}=await q.range(from,to);
      if(error){console.error('fetchPage:',error,errString(error));toast('โหลดข้อมูลไม่สำเร็จ');return{data:[],count:0}}
      state.total=typeof count==='number'?count:state.total;data.forEach(r=>state.rowsById[String(r.id)]=r);return{data,count:typeof count==='number'?count:null}}

    async function render(reset=false){if(state.loading)return;state.loading=true;let html='';if(reset){state.page=0;state.lastDayKey=null;state.rowsById={};elTimeline.innerHTML='';elTimeline.insertAdjacentHTML('beforeend',`<div class="skeleton"></div>`.repeat(4))}
      elTimeline.setAttribute('aria-busy','true');
      const {data,count}=await fetchPage();
      elTimeline.innerHTML = (state.page===0)?'':elTimeline.innerHTML;
      let lastKey=state.lastDayKey;
      for(const row of data){const k=dayKeyFrom(row.created_at);if(k!==lastKey){html+=dayHeaderHTML(k);lastKey=k}html+=eventItem(row)}
      if(html) elTimeline.insertAdjacentHTML('beforeend',html);
      state.lastDayKey=lastKey;
      const shown=(state.page+1)*state.size;
      const hasMore=(count!=null)?(shown<count):(data.length===state.size);
      $('#io-sentinel').dataset.hasMore=String(hasMore);
      elBtnMore.classList.toggle('show',hasMore);
      if(count===0&&state.page===0){elTimeline.innerHTML=`<div class="empty"><h2>ยังไม่มีประวัติ</h2><p>แตะปุ่ม ＋ เพื่อเพิ่มรายการแรก</p></div>`}
      state.loading=false;elTimeline.setAttribute('aria-busy','false')}

    async function autofill(){let guard=0;while($('#io-sentinel').dataset.hasMore==='true' && document.documentElement.scrollHeight<=window.innerHeight+200 && guard<6){state.page++;await render(false);guard++}}

    const elSheetAdd=$('#addSheet');
    const elAddForm=$('#addForm');
    const elAddLocal=$('#addLocal');
    const elAddNote=$('#addNote');
    const elAddStatuses=$('#addStatuses');

    const emailWithSuffix=local=>{const s=String(local||'').trim().toLowerCase();return s.includes('@')?s:(s?`${s}@gmail.com`:s)};

    function renderStatuses(container, base={}){container.innerHTML=apps.map(a=>{const v=(base[a.k]==='used')?'used':'unknown';return `<button type=\"button\" class=\"status-btn status-${v}\" data-app=\"${a.k}\" data-val=\"${v}\">${icons[a.cls]} <b>${a.n}</b> <span class=\"status-dot\"></span> <span class=\"status-text\">${statusText[v]}</span></button>`}).join('');$$('.status-btn',container).forEach(btn=>on(btn,'click',()=>{const cur=btn.dataset.val;const nxt=(cur==='used')?'unknown':'used';btn.dataset.val=nxt;btn.className=`status-btn status-${nxt}`;btn.querySelector('.status-text').textContent=statusText[nxt]}))}

    on($('#btnAdd'),'click',()=>{renderStatuses(elAddStatuses);elSheetAdd.showModal();setTimeout(()=>elAddLocal.focus(),50)});
    on($('#btnCancelAdd'),'click',()=>elSheetAdd.close());

    async function insertRow(payload){const {error}=await db.from(TABLE).insert([payload]);if(error)throw new Error(errString(error))}
    elAddForm.addEventListener('submit',async e=>{e.preventDefault();const email=emailWithSuffix(elAddLocal.value);if(!email){toast('กรอกชื่อผู้ใช้ก่อน');return}const payload={email,note:elAddNote.value.trim().slice(0,NOTE_MAX)};$$('.status-btn',elAddStatuses).forEach(b=>payload[b.dataset.app]=b.dataset.val);try{await insertRow(payload);toast('เพิ่มแล้ว');elSheetAdd.close();await render(true);await autofill()}catch(err){console.error('insertRow:',err,errString(err));toast('เพิ่มไม่สำเร็จ')}});

    function isValidPatch(p){if(!p||typeof p!=="object")return false;const ks=Object.keys(p);if(!ks.length)return false;for(const k of ks){if(!(ALLOWED_APPS.includes(k)||k==='note'))return false}return true}
    async function updateField(id,patch){const key=coerceId(id);if(!key||!isValidPatch(patch))throw new Error('invalid update params');const {data,error}=await db.from(TABLE).update(patch).eq('id',key).select('id');if(error)throw new Error(errString(error));if(!Array.isArray(data)||data.length===0)throw new Error('no rows updated')}
    async function deleteRow(id){const key=coerceId(id);const {error}=await db.from(TABLE).delete().eq('id',key);if(error)throw new Error(errString(error))}

    const pending=new Set();
    const pendKey=(id,app)=>`${id}::${app}`;
    function setBadgeBusy(b,flag){b.dataset.busy=flag?'1':'0';b.style.pointerEvents=flag?'none':''}
    function redrawBadge(b){const app=b.dataset.app;const id=b.dataset.id;const val=b.dataset.val;const cls=`badge-app ${tone(val)}`;b.className=cls;b.innerHTML=buildBadgeHTML(app,val,id)}
    function dbWriteStatusFor(val){return val==='unusable'?'unknown':val}

    elTimeline.addEventListener('click',async e=>{
      const del=e.target.closest('.ev-del');
      if(del){const id=del.dataset.id;if(!id)return;const ok=confirm('ลบรายการนี้หรือไม่?');if(!ok)return;del.disabled=true;try{await deleteRow(id);const article=del.closest('.event');if(article){article.style.opacity='.4';requestAnimationFrame(()=>article.remove())}delete state.rowsById[String(id)];toast('ลบแล้ว');await render(true);await autofill()}catch(err){console.error('delete:',err,errString(err));toast('ลบไม่สำเร็จ')}finally{del.disabled=false}return}

      const badge=e.target.closest('.badge-app');
      if(badge){try{if(badge.dataset.busy==='1')return;const app=badge.dataset.app||'';const id=badge.dataset.id||'';if(!id||!app||!ALLOWED_APPS.includes(app))throw new Error('invalid badge');const keyp=pendKey(id,app);if(pending.has(keyp))return;pending.add(keyp);const cur=badge.dataset.val;const idx=STATUS_CYCLE.indexOf(cur);const nxt=STATUS_CYCLE[(idx+1+STATUS_CYCLE.length)%STATUS_CYCLE.length];if(!STATUS_CYCLE.includes(nxt))throw new Error('invalid next');badge.dataset.val=nxt;redrawBadge(badge);const keyStr=String(id);const writeVal=dbWriteStatusFor(nxt);state.rowsById[keyStr]={...(state.rowsById[keyStr]||{}),[app]:writeVal};if(nxt==='unusable'){setOverride(id,app,'unusable')}else{setOverride(id,app,null)}setBadgeBusy(badge,true);await updateField(id,{[app]:writeVal});toast('อัปเดตสถานะแล้ว')}catch(err){console.error('update status:',err,errString(err));toast('อัปเดตไม่สำเร็จ');if(badge){const id=badge.dataset.id;const app=badge.dataset.app;const keyStr=String(id);const prevDb=state.rowsById[keyStr]?.[app];if(prevDb){badge.dataset.val=effectiveStatus(id,app,prevDb);redrawBadge(badge)}const prevOv=getOverride(id,app)||null;if(prevOv) setOverride(id,app,prevOv); else setOverride(id,app,null)} }finally{if(badge)setBadgeBusy(badge,false);if(badge)pending.delete(pendKey(badge.dataset.id,badge.dataset.app))}}
    });

    elTimeline.addEventListener('keydown',e=>{const n=e.target.closest('.note[contenteditable="true"]');if(n&&e.key==='Enter'){e.preventDefault();n.blur()}});
    elTimeline.addEventListener('focusin',e=>{const n=e.target.closest('.note[contenteditable="true"]');if(n){if(n.classList.contains('empty')){n.textContent='';n.classList.remove('empty')}n.classList.add('editing')}});
    elTimeline.addEventListener('focusout',async e=>{const n=e.target.closest('.note[contenteditable="true"]');if(n){const id=n.dataset.id;n.classList.remove('editing');const raw=n.textContent||'';const value=raw.trim().slice(0,NOTE_MAX);const key=String(id);const prev=(state.rowsById[key]?.note||'').trim();if(value===prev)return;state.rowsById[key]={...(state.rowsById[key]||{}),note:value};try{await updateField(id,{note:value});toast('บันทึกหมายเหตุแล้ว');if(!value){n.textContent='— ไม่มีหมายเหตุ —';n.classList.add('empty')}}catch(err){console.error('update note:',err,errString(err));toast('บันทึกไม่สำเร็จ');n.textContent=prev||'— ไม่มีหมายเหตุ —';if(!prev)n.classList.add('empty')}}});

    on($('#btnRefresh'),'click',async()=>{await render(true);await autofill();toast('รีเฟรชแล้ว')});
    on($('#btnTheme'),'click',()=>{const cur=document.documentElement.getAttribute('data-theme');applyTheme(cur==='dark'?'light':'dark')});
    on($('#btnMore'),'click',async()=>{if($('#io-sentinel').dataset.hasMore!=='true')return;state.page++;await render(false);await autofill()});

    let io=null;
    function setupIO(){if(!('IntersectionObserver' in window))return; if(io){try{io.disconnect()}catch{}} io=new IntersectionObserver(async es=>{for(const e of es){if(e.isIntersecting&&$('#io-sentinel').dataset.hasMore==='true'&&!state.loading){state.page++;await render(false)}}},{root:null,rootMargin:'1200px 0px 0px 0px',threshold:0});io.observe($('#io-sentinel'))}

    try{
      db.channel('realtime:email_usage')
        .on('postgres_changes',{event:'INSERT',schema:'public',table:TABLE},async ()=>{ if(state.page===0) {await render(true);await autofill()} })
        .on('postgres_changes',{event:'DELETE',schema:'public',table:TABLE},async ()=>{ if(state.page===0) {await render(true);await autofill()} })
        .on('postgres_changes',{event:'UPDATE',schema:'public',table:TABLE},async ()=>{})
        .subscribe();
    }catch(e){console.warn('realtime disabled:',e,errString(e))}

    function runTests(){const tests=[];const log=(n,ok,m='')=>console[ok?'log':'error'](`✅ ${n}`+(ok?'':` → ${m}`));
      tests.push(()=>log('UMD loaded',!!(window.supabase&&window.supabase.createClient)));
      tests.push(()=>log('client created',!!db));
      tests.push(()=>{const r='a\nb'.replace(/\n/g,' ');log('newline replace',r==='a b',r)});
      tests.push(()=>{const f={shopee:'all',gemini:'all',chatgpt:'all',tiktok:'all',hasNote:false};state.filters={...f};const cycle=['all','used','unknown'];const before=state.filters.shopee;const i=cycle.indexOf(before);for(const k of ['shopee','gemini','chatgpt','tiktok'])state.filters[k]=(k==='shopee')?cycle[(i+1)%cycle.length]:'all';const a=state.filters.shopee!=='all'&&state.filters.gemini==='all';log('single-select cycle 3 opts',a,JSON.stringify(state.filters))});
      tests.push(()=>{const v1=tone('used')==='ok';const v2=tone('unknown')==='unk';const v3=tone('unusable')==='bad';log('tone mapping used/unknown/unusable',v1&&v2&&v3)});
      tests.push(()=>{const html=renderBadgeEl('shopee','unusable','1');log('red status label',/ใช้งานไม่ได้/.test(html),html)});
      tests.push(()=>{const html=eventItem({id:1,email:'a@b.com',created_at:Date.now(),shopee:'used',gemini:'unknown',chatgpt:'unusable',tiktok:'unknown',note:''});log('delete btn exists',/ev-del/.test(html),html)});
      tests.push(()=>{const before=state.loading;state.loading=true;render(false);state.loading=before;log('render guard active',true)});
      tests.push(()=>{const a=errString(undefined);const b=errString({code:'x'});const c=errString('oops');const d=errString({message:'m',details:'d',hint:'h',code:'c'});log('errString rich fields',!!a&&!!b&&!!c&&/m \| d \| h \| c/.test(d),`${a}|${b}|${c}|${d}`)});
      tests.push(()=>{const s='x'.repeat(NOTE_MAX+10);const t=s.slice(0,NOTE_MAX);log('note length capped',t.length===NOTE_MAX,`${t.length}`)});
      tests.push(()=>{const a=coerceId('123')===123;const b=coerceId('001')===1;const c=coerceId('abc')==='abc';log('id coerce digits→number',a&&b&&c)});
      tests.push(()=>{const H=dayHeaderHTML('2025-1-1');log('day header html',/day-2025-1-1/.test(H),H)});
      tests.push(()=>{const k=dbWriteStatusFor('unusable')==='unknown'&&dbWriteStatusFor('used')==='used';log('db write mapping ok',k)});
      tests.push(()=>{const ok=isValidPatch({note:'x'})&&isValidPatch({shopee:'used'})&&!isValidPatch({badkey:'x'});log('patch validator',ok)});
      tests.push(()=>{const hmTrue=(function(){const d={length:state.size};return (d.length===state.size)})();log('hasMore fallback uses page size',hmTrue)});
    try{tests.forEach(t=>t())}catch(e){console.error('Self-tests error',e,errString(e))}}

    document.addEventListener('DOMContentLoaded',async()=>{initTheme();renderFilterChips();runTests();await render(true);setupIO();await autofill();
      setTimeout(()=>{if(!state.loading && elTimeline && elTimeline.innerText.trim()===''){render(true).then(()=>autofill())}},300);
      const syncTopbar=()=>{const h=document.querySelector('.topbar').offsetHeight||64;document.documentElement.style.setProperty('--topbar-h',h+'px')};
      syncTopbar();
      window.addEventListener('resize',syncTopbar,{passive:true});
      window.addEventListener('orientationchange',syncTopbar);
    });
  })();
  </script>
</body>
</html>

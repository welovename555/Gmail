<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>GmailSP • Mobile</title>
  <style>
    /* GmailSP — Mobile-first, single-file build (Pure HTML/CSS/JS)
       Redesigned for clarity, brightness, and thumb-friendly UX.
       Uses the SAME Supabase table/API contract as the original app.
       Light theme by default for readability in daylight. */

    :root{
      --bg: #f7fafc;          /* light background */
      --panel: #ffffff;       /* cards/panels */
      --surface: #ffffff;
      --muted: #6b7280;       /* subdued text */
      --text: #111827;        /* main text */
      --primary: #0ea5e9;     /* sky-500 */
      --primary-2: #38bdf8;   /* sky-400 */
      --ok: #10b981;          /* emerald-500 */
      --warn: #f59e0b;        /* amber-500 */
      --bad: #ef4444;         /* red-500 */
      --ring: #e5e7eb;        /* borders */

      --radius: 16px;
      --radius-lg: 20px;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --shadow-sm: 0 2px 8px rgba(2,6,23,.06);

      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    html,body{height:100%;}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility; line-height:1.35;
    }

    /* AppBar */
    .appbar{
      position: sticky; top:0; z-index:50; background: var(--panel);
      padding: calc(8px + var(--safe-top)) 14px 8px; box-shadow: var(--shadow-sm);
      display:flex; align-items:center; gap:12px; border-bottom:1px solid var(--ring);
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; }
    .brand .logo{ width:32px; height:32px; border-radius:10px; background:radial-gradient(circle at 30% 30%, var(--primary-2), var(--primary)); display:grid; place-items:center; box-shadow: inset 0 0 0 2px rgba(255,255,255,.65);} 
    .brand .logo span{ font-size:14px; color:white; font-weight:900; filter: drop-shadow(0 1px 0 rgba(0,0,0,.25));}

    .appbar-actions{ margin-left:auto; display:flex; gap:6px; }
    .i-btn{
      appearance:none; border:0; background:transparent; color:var(--text);
      width:40px; height:40px; border-radius:12px; display:grid; place-items:center;
      transition: transform .18s ease, background-color .18s ease, opacity .18s ease; will-change: transform;
    }
    .i-btn:active{ transform: scale(.94); }
    .i-btn:hover{ background:rgba(2,6,23,.06); }

    /* Search bar + Quick Add */
    .search{ padding:10px 14px 8px; background: var(--panel); border-bottom:1px solid var(--ring); position: sticky; top:56px; z-index:40; }
    .field{ display:flex; align-items:center; gap:8px; background:var(--surface); border:1px solid var(--ring); border-radius:12px; padding:10px 12px; }
    .field input{ flex:1; outline:none; border:0; background:transparent; color:var(--text); font-size:16px; padding:2px; min-width:0; }

    .quickadd{ margin-top:10px; background:var(--panel); border:1px dashed var(--ring); border-radius:14px; padding:10px; }
    .quickadd .row{ display:flex; align-items:center; gap:8px; }
    .quickadd .row + .row{ margin-top:8px; }
    .qa-email{ flex:1; border:1px solid var(--ring); border-radius:12px; padding:10px 12px; font-size:16px; }
    .qa-note{ width:100%; border:1px solid var(--ring); border-radius:12px; padding:10px 12px; font-size:15px; min-height:46px; }
    .qa-label{ font-size:12px; color:var(--muted); }
    .qa-chips{ display:flex; gap:6px; overflow:auto; padding:4px 0; }
    .qa-chip{ padding:6px 10px; border-radius:999px; border:1px solid var(--ring); background:#f8fafc; font-size:12px; white-space:nowrap; }
    .qa-add{ padding:10px 14px; border-radius:12px; border:0; font-weight:800; color:white; background:linear-gradient(180deg, var(--primary-2), var(--primary)); }

    .chipbar{ display:flex; gap:8px; margin-top:10px; overflow:auto; padding-bottom:2px; }
    .chip{ white-space:nowrap; padding:6px 10px; border-radius:999px; border:1px solid var(--ring); background:#f8fafc; font-size:13px; }

    /* List */
    .list{ padding:12px 12px calc(86px + var(--safe-bottom)); display:grid; gap:10px; }
    .card{ background:var(--panel); border:1px solid var(--ring); border-radius:var(--radius-lg); box-shadow: var(--shadow); padding:12px; display:grid; gap:8px; transform: translateZ(0); transition: transform .25s ease, box-shadow .25s ease, opacity .25s ease; will-change: transform, opacity; }
    .card:active{ transform: scale(.995); }
    .row{ display:flex; align-items:center; gap:10px; min-width:0; }
    .email{ font-weight:800; font-size:17px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .note{ font-size:13px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .statuses{ display:flex; gap:8px; margin-left:auto; }
    .status-chip{ display:inline-flex; align-items:center; gap:6px; padding:7px 10px; border-radius:999px; border:1px solid var(--ring); background:#f8fafc; font-size:12px; line-height:1; user-select:none; -webkit-tap-highlight-color: transparent; transition: transform .18s ease, background-color .18s ease, border-color .18s ease; }
    .status-chip:active{ transform: scale(.94); }
    .dot{ width:9px; height:9px; border-radius:999px; background:#cbd5e1; box-shadow: inset 0 0 0 1px rgba(0,0,0,.04); }
    .s-used .dot{ background:var(--ok); }
    .s-unused .dot{ background:var(--bad); }
    .s-unknown .dot{ background:var(--warn); }

    .app-badge{ width:22px; height:22px; border-radius:8px; display:grid; place-items:center; font-size:12px; font-weight:900; color:white; }
    .app-S{ background:#ee4d2d; }
    .app-G{ background:#4285f4; }
    .app-C{ background:#7c3aed; }
    .app-T{ background:#000000; }

    .actions{ margin-left:4px; display:flex; gap:6px; }

    /* Bottom Nav + FAB */
    .navbar{ position: fixed; bottom:0; left:0; right:0; padding: 10px 14px calc(10px + var(--safe-bottom)); background: var(--panel); border-top:1px solid var(--ring); display:flex; gap:10px; justify-content:space-between; align-items:center; z-index:60; backdrop-filter: saturate(140%) blur(6px); }
    .nav-btn{ flex:1; display:grid; place-items:center; gap:6px; padding:10px 0; border-radius:14px; border:1px solid var(--ring); background:#f8fafc; font-size:12px; }
    .fab{ position: fixed; right:16px; bottom: calc(64px + var(--safe-bottom)); width:56px; height:56px; border-radius:18px; display:grid; place-items:center; color:white; background:linear-gradient(180deg, var(--primary-2), var(--primary)); box-shadow: var(--shadow); z-index:70; border:0; -webkit-tap-highlight-color: transparent; transform: translateZ(0); transition: transform .18s ease, box-shadow .18s ease; will-change: transform; }
    .fab:active{ transform: scale(.96); }

    /* Dialog (Bottom Sheet) */
    dialog.sheet{ border:0; padding:0; background:transparent; }
    .sheet::backdrop{ background: rgba(0,0,0,.25); backdrop-filter: blur(2px); }
    .panel{ width:100%; max-height:85vh; background:var(--panel); border-radius:20px 20px 0 0; border:1px solid var(--ring); position: fixed; left:0; right:0; bottom:0; box-shadow: var(--shadow); transform: translate3d(0, 100%, 0); transition: transform .33s cubic-bezier(.22,.95,.19,1), opacity .2s ease; will-change: transform; }
    dialog[open] .panel{ transform: translate3d(0,0,0); }
    .grab{ width:42px; height:5px; border-radius:999px; background:#e5e7eb; margin:10px auto; }
    .sheet-body{ padding:6px 14px 14px; display:grid; gap:10px; }

    .form{ display:grid; gap:12px; }
    .label{ font-size:12px; color:var(--muted); }
    .input, .select, textarea{ width:100%; border-radius:14px; border:1px solid var(--ring); background:var(--surface); color:var(--text); padding:12px; font-size:15px; outline:none; }
    textarea{ resize: vertical; min-height:70px; }

    .btn{ appearance:none; border:0; border-radius:12px; padding:12px 14px; font-weight:700; }
    .btn.primary{ background: linear-gradient(180deg, var(--primary-2), var(--primary)); color:white; }
    .btn.ghost{ background: #f8fafc; border:1px solid var(--ring); color:var(--text); }

    /* Toasts */
    .toastwrap{ position: fixed; inset: auto 0 calc(110px + var(--safe-bottom)) 0; display:grid; place-items:center; pointer-events:none; z-index:100; }
    .toast{ background:#111827; color:white; border:0; border-radius:999px; padding:10px 14px; box-shadow: var(--shadow-sm); opacity:0; transform: translateY(10px); transition: transform .2s ease, opacity .2s ease; }
    .toast.show{ opacity:1; transform: translateY(0); }

    /* Skeleton */
    .skeleton{ position:relative; overflow:hidden; background: linear-gradient(90deg, rgba(0,0,0,.05), rgba(0,0,0,.12), rgba(0,0,0,.05)); background-size:200% 100%; animation: shimmer 1.1s linear infinite; }
    @keyframes shimmer{ 0%{ background-position:200% 0 } 100%{ background-position:-200% 0 } }

    /* Misc */
    .hidden{ display:none !important; }
    .tight{ margin:-6px -10px; }

    /* Empty state */
    .empty{ margin: 16vh 16px 0; text-align:center; color:var(--muted); }
    .empty h2{ margin:0 0 10px; color:var(--text); }
    .empty p{ margin:0 0 14px; }

    @media (prefers-reduced-motion: reduce){ *{ animation:none !important; transition: none !important; } }
  </style>
</head>
<body>
  <header class="appbar" role="banner">
    <div class="brand">
      <div class="logo"><span>SP</span></div>
      <div>
        <div style="font-size:15px; line-height:1;">GmailSP</div>
        <div style="font-size:11px; line-height:1; color:var(--muted);">ติดตามการใช้งานอีเมล</div>
      </div>
    </div>
    <div class="appbar-actions">
      <button class="i-btn" id="btnRefresh" title="รีเฟรช" aria-label="รีเฟรช">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"></path><path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14"></path></svg>
      </button>
      <button class="i-btn" id="btnFilters" title="ตัวกรอง" aria-label="ตัวกรอง">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 4 21 4 14 12 14 20 10 22 10 12 3 4"></polygon></svg>
      </button>
      <button class="i-btn" id="btnSettings" title="ตั้งค่า" aria-label="ตั้งค่า">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 7.04 4.3l.06.06a1.65 1.65 0 0 0 1.82.33h.18A1.65 1.65 0 0 0 10.6 3.2V3a2 2 0 1 1 4 0v.09c0 .66.38 1.26.97 1.54.15.08.31.15.48.19.6.16 1.23.03 1.7-.39l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06c-.42.47-.55 1.1-.39 1.7.04.17.11.33.19.48.28.59.88.97 1.54.97H21a2 2 0 1 1 0 4h-.09c-.66 0-1.26.38-1.54.97z"/></svg>
      </button>
    </div>
  </header>

  <section class="search" role="search">
    <div class="field" id="searchField">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
      <input id="q" type="search" placeholder="ค้นหาอีเมล…" autocomplete="off" maxlength="120" />
      <button class="i-btn" id="btnClearQ" title="ล้าง" aria-label="ล้าง">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>

    <!-- QUICK ADD (เหมือนเวอร์ชันต้นฉบับ แต่ UI ใหม่) -->
    <div class="quickadd" id="quickadd">
      <div class="row">
        <input class="qa-email" id="qaEmail" type="email" placeholder="เพิ่มอีเมลใหม่ (example@gmail.com)" />
        <button class="qa-add" id="qaAdd">เพิ่ม</button>
      </div>
      <div class="row" style="justify-content:space-between;">
        <div class="qa-label">สถานะการใช้งานแต่ละแอป (แตะเพื่อสลับ)</div>
        <div class="statuses" id="qaStatuses"></div>
      </div>
      <div class="row">
        <textarea class="qa-note" id="qaNote" placeholder="หมายเหตุ (ไม่บังคับ)"></textarea>
      </div>
      <div class="qa-chips" id="qaNotePresets">
        <button type="button" class="qa-chip" data-note="OTPGmail✅">OTPGmail✅</button>
        <button type="button" class="qa-chip" data-note="OTPShopee✅">OTPShopee✅</button>
        <button type="button" class="qa-chip" data-note="ใช้กับ Gemini แล้ว">ใช้กับ Gemini แล้ว</button>
        <button type="button" class="qa-chip" data-note="สมัคร ChatGPT แล้ว">สมัคร ChatGPT แล้ว</button>
      </div>
    </div>

    <div class="chipbar" id="chipbar"></div>
  </section>

  <main class="list" id="list" role="list"></main>
  <div id="sentinel" class="hidden" aria-hidden="true"></div>

  <button class="fab" id="btnAdd" aria-label="เพิ่มอีเมล">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
  </button>

  <nav class="navbar" role="navigation" aria-label="เมนูด้านล่าง">
    <button class="nav-btn" id="btnSort">
      <div>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 16h18"></path><path d="M6 12h12"></path><path d="M9 8h6"></path></svg>
      </div>
      <div>เรียง</div>
    </button>
    <button class="nav-btn" id="btnStats">
      <div>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18"></path><path d="M3 19h18"></path><rect x="7" y="12" width="3" height="5"></rect><rect x="12" y="7" width="3" height="10"></rect><rect x="17" y="10" width="3" height="7"></rect></svg>
      </div>
      <div>สถิติ</div>
    </button>
    <button class="nav-btn" id="btnBulk">
      <div>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="7" height="7" rx="1"></rect><rect x="14" y="4" width="7" height="7" rx="1"></rect><rect x="14" y="15" width="7" height="7" rx="1"></rect><rect x="3" y="15" width="7" height="7" rx="1"></rect></svg>
      </div>
      <div>จัดการ</div>
    </button>
  </nav>

  <!-- Add/Edit Sheet -->
  <dialog class="sheet" id="editSheet">
    <div class="panel" role="dialog" aria-labelledby="editTitle">
      <div class="grab"></div>
      <div class="sheet-body">
        <div id="editTitle" style="font-weight:800; font-size:18px;">เพิ่ม/แก้ไขอีเมล</div>
        <form class="form" id="editForm">
          <div>
            <div class="label">อีเมล</div>
            <input class="input" id="fEmail" type="email" placeholder="example@gmail.com" required />
          </div>
          <div class="row" style="gap:10px; justify-content:space-between;">
            <div class="label">สถานะการใช้งาน</div>
            <div class="row statuses" id="editStatuses" aria-label="ปรับสถานะแต่ละแอป"></div>
          </div>
          <div>
            <div class="label">หมายเหตุ</div>
            <textarea id="fNote" placeholder="เช่น ส่ง OTP แล้ว, ใช้สมัคร Shopee แล้ว"></textarea>
          </div>
          <div class="row" style="gap:10px;">
            <button type="button" class="btn ghost" id="btnCancelEdit">ยกเลิก</button>
            <button type="submit" class="btn primary" id="btnSave">บันทึก</button>
          </div>
        </form>
      </div>
    </div>
  </dialog>

  <!-- Filters Sheet -->
  <dialog class="sheet" id="filterSheet">
    <div class="panel" role="dialog" aria-labelledby="filterTitle">
      <div class="grab"></div>
      <div class="sheet-body">
        <div id="filterTitle" style="font-weight:800; font-size:18px;">ตัวกรอง</div>
        <div class="form">
          <div class="row" style="justify-content:space-between;">
            <div class="label">Shopee</div>
            <select id="fltShopee" class="select">
              <option value="all">ทั้งหมด</option>
              <option value="used">ใช้แล้ว</option>
              <option value="unused">ยังไม่ใช้</option>
              <option value="unknown">ไม่ทราบ</option>
            </select>
          </div>
          <div class="row" style="justify-content:space-between;">
            <div class="label">Gemini</div>
            <select id="fltGemini" class="select">
              <option value="all">ทั้งหมด</option>
              <option value="used">ใช้แล้ว</option>
              <option value="unused">ยังไม่ใช้</option>
              <option value="unknown">ไม่ทราบ</option>
            </select>
          </div>
          <div class="row" style="justify-content:space-between;">
            <div class="label">ChatGPT</div>
            <select id="fltChatgpt" class="select">
              <option value="all">ทั้งหมด</option>
              <option value="used">ใช้แล้ว</option>
              <option value="unused">ยังไม่ใช้</option>
              <option value="unknown">ไม่ทราบ</option>
            </select>
          </div>
          <div class="row" style="justify-content:space-between;">
            <div class="label">TikTok</div>
            <select id="fltTiktok" class="select">
              <option value="all">ทั้งหมด</option>
              <option value="used">ใช้แล้ว</option>
              <option value="unused">ยังไม่ใช้</option>
              <option value="unknown">ไม่ทราบ</option>
            </select>
          </div>
          <div class="row" style="justify-content:space-between;">
            <div class="label">เรียงตาม</div>
            <select id="sortBy" class="select">
              <option value="created_at|desc">ใหม่ล่าสุด</option>
              <option value="created_at|asc">เก่าสุด</option>
              <option value="email|asc">อีเมล A→Z</option>
              <option value="email|desc">อีเมล Z→A</option>
            </select>
          </div>
          <div class="row" style="gap:10px;">
            <button type="button" class="btn ghost" id="btnCancelFilter">ปิด</button>
            <button type="button" class="btn primary" id="btnApplyFilter">ใช้ตัวกรอง</button>
          </div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Toasts -->
  <div class="toastwrap"><div class="toast" id="toast"></div></div>

  <!-- TYPE=MODULE to mirror original API import style -->
  <script type="module">
  import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';

  // ====== CONFIG (from original app.js) ======
  // We detected the original Supabase URL from your project. Key is required to access real data.
  const SUPABASE_URL = 'https://tuyttwketzbewvqqqdum.supabase.co';
  // NOTE: The original key in your app.js is truncated in the provided zip. Please paste your full anon key below
  // or set it once via localStorage prompt that will show on first run.
  let SUPABASE_ANON_KEY = localStorage.getItem('gmailsp_supabase_key') || '';

  // ====== TABLE CONTRACT (unchanged from original) ======
  const TABLE = 'email_usage';
  const apps = [
    { key:'shopee', label:'Shopee', tag:'S' },
    { key:'gemini', label:'Gemini', tag:'G' },
    { key:'chatgpt', label:'ChatGPT', tag:'C' },
    { key:'tiktok', label:'TikTok', tag:'T' },
  ];
  const STATUS = ['used','unused','unknown'];
  const statusLabel = { used:'ใช้แล้ว', unused:'ยังไม่ใช้', unknown:'ไม่ทราบ' };

  // ====== DOM ======
  const $ = (s, p=document) => p.querySelector(s);
  const $$ = (s, p=document) => [...p.querySelectorAll(s)];
  const on = (el, ev, fn, opts={ passive:true }) => el.addEventListener(ev, fn, opts);

  const elList = $('#list');
  const elQ = $('#q');
  const elClearQ = $('#btnClearQ');
  const elToast = $('#toast');
  const elSentinel = $('#sentinel');
  const elFilterSheet = $('#filterSheet');
  const elEditSheet = $('#editSheet');
  const elEditForm = $('#editForm');
  const fEmail = $('#fEmail');
  const fNote = $('#fNote');
  const editStatuses = $('#editStatuses');

  // Quick Add
  const qaEmail = $('#qaEmail');
  const qaNote = $('#qaNote');
  const qaStatuses = $('#qaStatuses');
  const qaAdd = $('#qaAdd');

  // === Selector helpers (safe for attribute selectors) ===
  const attrSelEscape = (s) => String(s).replace(/\\/g, "\\\\").replace(/"/g, '\\"');
  const cardSel = (email) => `.card[data-email="${attrSelEscape(email)}"]`;

  const toast = (msg) => { elToast.textContent = msg; elToast.classList.add('show'); setTimeout(()=>elToast.classList.remove('show'), 1400); };
  const debounce = (fn, ms=280) => { let t; return (...a) => { clearTimeout(t); t=setTimeout(()=>fn(...a), ms) } };

  const state = JSON.parse(localStorage.getItem('gmailsp_mobile_state') || '{}');
  Object.assign(state, {
    q: state.q ?? '',
    filters: state.filters ?? { shopee:'all', gemini:'all', chatgpt:'all', tiktok:'all' },
    sortBy: state.sortBy ?? 'created_at',
    sortDir: state.sortDir ?? 'desc',
    pageSize: state.pageSize ?? 40,
    page: 0,
    loading: false,
    total: 0,
  });
  const saveState = () => localStorage.setItem('gmailsp_mobile_state', JSON.stringify(state));

  // ====== SUPABASE ======
  let supa = null;
  function ensureKey(){
    if (!SUPABASE_ANON_KEY){
      const k = prompt('กรอก SUPABASE ANON KEY เพื่อเชื่อมต่อข้อมูลจริง:', '');
      if (k) { SUPABASE_ANON_KEY = k.trim(); localStorage.setItem('gmailsp_supabase_key', SUPABASE_ANON_KEY); }
    }
  }
  async function initSupa(){
    try{
      ensureKey();
      if (!SUPABASE_ANON_KEY) return null;
      supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      return supa;
    }catch(e){ console.error(e); toast('ตั้งค่า Supabase ไม่สำเร็จ'); return null; }
  }

  // ====== UI Helpers ======
  function classForStatus(s){ return s ? `s-${s}` : 's-unknown'; }
  function nextStatus(cur){ const i = STATUS.indexOf(cur); return STATUS[(i+1)%STATUS.length]; }
  function chipTemplate(field, value){
    const app = apps.find(a=>a.key===field);
    return `<button type="button" class="status-chip ${classForStatus(value)}" data-field="${field}" data-value="${value||'unknown'}"><span class="app-badge app-${app.tag}">${app.tag}</span><span class="dot"></span><span>${statusLabel[value||'unknown']}</span></button>`;
  }
  function cardTemplate(row){
    const note = row.note ? String(row.note).replace(/\n/g,' ').slice(0,120) : '';
    return `<article class="card" role="listitem" data-email="${row.email}">
      <div class="row">
        <div class="email" title="${row.email}">${row.email}</div>
        <div class="actions">
          <button class="i-btn" aria-label="แก้ไข" data-act="edit">✏️</button>
          <button class="i-btn" aria-label="ลบ" data-act="del">🗑️</button>
        </div>
      </div>
      <div class="row tight"><div class="statuses" role="group" aria-label="สถานะ">${chipTemplate('shopee', row.shopee)}${chipTemplate('gemini', row.gemini)}${chipTemplate('chatgpt', row.chatgpt)}${chipTemplate('tiktok', row.tiktok)}</div></div>
      <div class="row"><div class="note" title="${note}">${note || '— ไม่มีหมายเหตุ —'}</div></div>
    </article>`;
  }
  function skeletonCard(){ return `<article class="card skeleton" style="height:86px; border-radius:var(--radius-lg);"></article>`; }

  // ====== DATA ======
  async function fetchPage(){
    let q = supa.from(TABLE).select('*', { count:'exact' });
    if (state.q) q = q.ilike('email', `%${state.q}%`);
    for (const {key} of apps){ const v = state.filters[key]; if (v && v!=='all') q = q.eq(key, v); }
    q = q.order(state.sortBy, { ascending: state.sortDir === 'asc' });
    const from = state.page * state.pageSize; const to = from + state.pageSize - 1; q = q.range(from, to);
    const { data, count, error } = await q;
    if (error){ console.error(error); toast('โหลดข้อมูลล้มเหลว'); return { data:[], count:0 } }
    state.total = count || 0; return { data, count: state.total };
  }

  async function load(reset=false){
    if (!supa) return;
    if (state.loading) return; state.loading=true;
    if (reset){ state.page=0; elList.innerHTML=''; elList.insertAdjacentHTML('beforeend', skeletonCard().repeat(4)); }
    saveState();
    const { data, count } = await fetchPage();
    if (state.page===0) elList.innerHTML='';
    const chunk=16; for (let i=0;i<data.length;i+=chunk){ elList.insertAdjacentHTML('beforeend', data.slice(i,i+chunk).map(cardTemplate).join('')); await new Promise(r=>requestAnimationFrame(r)); }
    bindCardEvents();
    const shown = (state.page+1)*state.pageSize; elSentinel.classList.toggle('hidden', !(shown<count));
    updateChipbarSummary(); state.loading=false;
  }

  function bindCardEvents(){
    $$('.card').forEach(card => {
      const email = card.dataset.email;
      $$('[data-act]', card).forEach(btn=> on(btn,'click',()=>{ const act=btn.dataset.act; if(act==='edit') openEdit(email); if(act==='del') confirmDelete(email); }));
      $$('.status-chip', card).forEach(chip => on(chip,'click', async ()=>{ const field=chip.dataset.field; const cur=chip.dataset.value; const nxt=nextStatus(cur); await updateStatus(email, field, nxt); chip.dataset.value=nxt; chip.className=`status-chip ${classForStatus(nxt)}`; chip.querySelector('span:last-child').textContent = statusLabel[nxt]; }));
    });
  }

  async function upsertRow(payload){
    const { error } = await supa.from(TABLE).upsert(payload, { onConflict:'email' });
    if (error){ console.error(error); toast('บันทึกไม่สำเร็จ'); return }
    toast('บันทึกแล้ว'); await reloadAfterChange(payload.email);
  }
  async function updateStatus(email, field, value){
    const { error } = await supa.from(TABLE).update({ [field]: value }).eq('email', email);
    if (error){ console.error(error); toast('อัปเดตไม่สำเร็จ'); return }
    toast('อัปเดตแล้ว');
  }
  async function confirmDelete(email){
    if (!confirm(`ลบรายการ\n${email}?`)) return;
    const { error } = await supa.from(TABLE).delete().eq('email', email);
    if (error){ console.error(error); toast('ลบไม่สำเร็จ'); return }
    toast('ลบแล้ว'); await reloadAfterChange();
  }
  async function reloadAfterChange(focusEmail){
    state.page=0; await load(true);
    if (focusEmail){ const card = document.querySelector(cardSel(focusEmail)); if(card){ card.scrollIntoView({behavior:'smooth', block:'center'}); card.style.outline='2px solid var(--primary)'; setTimeout(()=>card.style.outline='none', 1000); } }
  }

  // ====== EDIT SHEET ======
  function openEdit(email){
    if (email){
      const card = document.querySelector(cardSel(email));
      const statuses = {}; apps.forEach(a => { const chip = card.querySelector(`.status-chip[data-field="${a.key}"]`); statuses[a.key] = chip?.dataset.value || 'unknown'; });
      fEmail.value = email; fEmail.readOnly = true; fNote.value = card.querySelector('.note')?.getAttribute('title') || '';
      renderEditStatuses(statuses);
    } else {
      fEmail.value=''; fEmail.readOnly=false; fNote.value=''; renderEditStatuses({ shopee:'unknown', gemini:'unknown', chatgpt:'unknown', tiktok:'unknown' });
    }
    elEditSheet.showModal();
  }
  function renderEditStatuses(statuses){ editStatuses.innerHTML = apps.map(a => chipTemplate(a.key, statuses[a.key]||'unknown')).join(''); $$('.status-chip', editStatuses).forEach(chip => on(chip,'click',()=>{ const cur=chip.dataset.value; const nxt=nextStatus(cur); chip.dataset.value=nxt; chip.className=`status-chip ${classForStatus(nxt)}`; chip.querySelector('span:last-child').textContent = statusLabel[nxt]; })); }
  on($('#btnCancelEdit'),'click',()=> elEditSheet.close());
  on($('#btnAdd'),'click',()=> openEdit());
  on(elEditForm,'submit', async (e)=>{ e.preventDefault(); const payload={ email:fEmail.value.trim().toLowerCase(), note:fNote.value.trim(), created_at:new Date().toISOString() }; $$('.status-chip', editStatuses).forEach(chip => payload[chip.dataset.field]=chip.dataset.value); if(!payload.email){ toast('กรอกอีเมลก่อน'); return } await upsertRow(payload); elEditSheet.close(); });

  // ====== FILTERS ======
  function openFilters(){ $('#fltShopee').value=state.filters.shopee; $('#fltGemini').value=state.filters.gemini; $('#fltChatgpt').value=state.filters.chatgpt; $('#fltTiktok').value=state.filters.tiktok; $('#sortBy').value=`${state.sortBy}|${state.sortDir}`; elFilterSheet.showModal(); }
  on($('#btnFilters'),'click', openFilters);
  on($('#btnCancelFilter'),'click',()=> elFilterSheet.close());
  on($('#btnApplyFilter'),'click', async ()=>{ state.filters.shopee=$('#fltShopee').value; state.filters.gemini=$('#fltGemini').value; state.filters.chatgpt=$('#fltChatgpt').value; state.filters.tiktok=$('#fltTiktok').value; const [sb,sd]=$('#sortBy').value.split('|'); state.sortBy=sb; state.sortDir=sd; saveState(); elFilterSheet.close(); await load(true); });
  on($('#btnSort'),'click', openFilters);

  // ====== STATS ======
  on($('#btnStats'),'click', async ()=>{
    const { data, error } = await supa.from(TABLE).select('shopee,gemini,chatgpt,tiktok').limit(2000);
    const counts = { shopee:{}, gemini:{}, chatgpt:{}, tiktok:{} };
    if (!error && Array.isArray(data)) data.forEach(r=> apps.forEach(a=>{ const v=(r[a.key]||'unknown'); counts[a.key][v]=(counts[a.key][v]||0)+1; }));
    const popup=document.createElement('div'); Object.assign(popup.style,{position:'fixed',inset:'0',background:'rgba(0,0,0,.25)',backdropFilter:'blur(2px)',zIndex:99,display:'grid',placeItems:'end center',padding:'14px'});
    popup.innerHTML = `<div style="width:100%; max-width:560px; background:var(--panel); border:1px solid var(--ring); border-radius:16px; box-shadow:var(--shadow); padding:12px 14px;">
      <div style="font-weight:800; font-size:16px; margin-bottom:8px;">สถิติโดยย่อ</div>
      ${apps.map(a=>{ const map=counts[a.key]||{}; return `<div class=\"row\" style=\"justify-content:space-between;\"><div class=\"row\" style=\"gap:8px;\"><span class=\"app-badge app-${a.tag}\">${a.tag}</span> <b>${a.label}</b></div><div style=\"font-size:13px; color:var(--muted);\">ใช้แล้ว ${map.used||0} · ยังไม่ใช้ ${map.unused||0} · ไม่ทราบ ${map.unknown||0}</div></div>` }).join('')}
      <div class="row" style="justify-content:flex-end; gap:10px; margin-top:10px;"><button class="btn primary" id="closeStats">ปิด</button></div>
    </div>`;
    document.body.appendChild(popup); on($('#closeStats',popup),'click',()=>popup.remove()); on(popup,'click',(e)=>{ if(e.target===popup) popup.remove(); });
  });

  // ====== BULK ======
  on($('#btnBulk'),'click', async ()=>{
    const popup=document.createElement('div'); Object.assign(popup.style,{position:'fixed',inset:'0',background:'rgba(0,0,0,.25)',backdropFilter:'blur(2px)',zIndex:99,display:'grid',placeItems:'end center',padding:'14px'});
    popup.innerHTML = `<div style="width:100%; max-width:560px; background:var(--panel); border:1px solid var(--ring); border-radius:16px; box-shadow:var(--shadow); padding:12px 14px;">
      <div style="font-weight:800; font-size:16px; margin-bottom:8px;">เพิ่มหลายรายการ</div>
      <div class="form">
        <div class="label">ใส่อีเมลทีละบรรทัด</div>
        <textarea id="bulkInput" placeholder="a@gmail.com\nb@gmail.com\n..."></textarea>
        <div class="row" style="gap:10px; justify-content:flex-end;">
          <button class="btn ghost" id="bulkCancel">ยกเลิก</button>
          <button class="btn primary" id="bulkAdd">เพิ่ม</button>
        </div>
      </div>
    </div>`;
    document.body.appendChild(popup);
    const bulkInput=$('#bulkInput',popup);
    on($('#bulkCancel',popup),'click',()=>popup.remove());
    on($('#bulkAdd',popup),'click', async ()=>{
      const lines=bulkInput.value.split(/\n+/).map(s=>s.trim().toLowerCase()).filter(Boolean);
      if(!lines.length){ toast('ว่างเปล่า'); return }
      const now=new Date().toISOString();
      const rows=lines.map(email=>({ email, note:'', shopee:'unknown', gemini:'unknown', chatgpt:'unknown', tiktok:'unknown', created_at:now }));
      const { error } = await supa.from(TABLE).upsert(rows, { onConflict:'email' });
      if (error){ console.error(error); toast('เพิ่มไม่สำเร็จ'); return }
      popup.remove(); toast(`เพิ่มแล้ว ${rows.length} รายการ`); await reloadAfterChange();
    });
    on(popup,'click',(e)=>{ if(e.target===popup) popup.remove(); });
  });

  // ====== SEARCH ======
  elQ.value = state.q; if(!state.q) $('#btnClearQ').style.opacity=.35;
  on(elQ,'input', debounce(async ()=>{ state.q=elQ.value.trim(); $('#btnClearQ').style.opacity = state.q?1:.35; await load(true); }, 260));
  on(elClearQ,'click', async ()=>{ elQ.value=''; state.q=''; await load(true); });

  // ====== INFINITE SCROLL ======
  if('IntersectionObserver' in window){ const io=new IntersectionObserver(async es=>{ for (const e of es){ if(e.isIntersecting && !state.loading){ state.page++; await load(false); } } }, { rootMargin:'400px 0px 0px 0px' }); io.observe(elSentinel); }

  // ====== CHIPBAR SUMMARY ======
  function updateChipbarSummary(){ const bar=$('#chipbar'); bar.innerHTML=''; const items=[{k:'shopee',label:'Shopee'},{k:'gemini',label:'Gemini'},{k:'chatgpt',label:'ChatGPT'},{k:'tiktok',label:'TikTok'}]; items.forEach(it=>{ const v=state.filters[it.k]; const text=v==='all'?'ทั้งหมด':statusLabel[v]; const chip=document.createElement('button'); chip.className='chip'; chip.textContent=`${it.label}: ${text}`; on(chip,'click', openFilters); bar.appendChild(chip); }); const meta=document.createElement('div'); meta.className='chip'; meta.textContent=`ทั้งหมด ~${state.total} รายการ`; bar.appendChild(meta); }

  // ====== QUICK ADD ======
  function renderQAStatuses(){ qaStatuses.innerHTML = apps.map(a=> chipTemplate(a.key,'unknown')).join(''); $$('.status-chip', qaStatuses).forEach(chip => on(chip,'click',()=>{ const cur=chip.dataset.value; const nxt=nextStatus(cur); chip.dataset.value=nxt; chip.className=`status-chip ${classForStatus(nxt)}`; chip.querySelector('span:last-child').textContent=statusLabel[nxt]; })); }
  renderQAStatuses();
  $$('#qaNotePresets .qa-chip').forEach(btn => on(btn,'click',()=>{ const t=btn.dataset.note; qaNote.value = qaNote.value ? (qaNote.value + ' • ' + t) : t; }));
  on(qaAdd,'click', async ()=>{ const email=qaEmail.value.trim().toLowerCase(); if(!email){ toast('กรอกอีเมลก่อน'); return } const payload={ email, note: qaNote.value.trim(), created_at: new Date().toISOString() }; $$('.status-chip', qaStatuses).forEach(chip=> payload[chip.dataset.field]=chip.dataset.value); await upsertRow(payload); qaEmail.value=''; qaNote.value=''; renderQAStatuses(); });

  // ====== BASIC SELF-TESTS (debug visibility for developer) ======
  function runSelfTests(){
    const tests = [];
    // 1) Regex newline replacement
    tests.push(() => {
      const s = 'line1\nline2';
      const r = String(s).replace(/\n/g,' ');
      if (r !== 'line1 line2') throw new Error('newline replace failed');
    });
    // 2) Bulk split by newlines
    tests.push(() => {
      const input = 'a@a.com\n\n b@b.com \n c@c.com ';
      const lines = input.split(/\n+/).map(v=>v.trim()).filter(Boolean);
      if (lines.length !== 3 || lines[1] !== 'b@b.com') throw new Error('bulk split failed');
    });
    // 3) Attribute selector escaping
    tests.push(() => {
      const sel = cardSel('a"b\\c@d');
      if (!sel.includes('a\\"b\\\\c@d')) throw new Error('attrSelEscape failed');
    });
    let passed = 0; const errors = [];
    tests.forEach(t=>{ try{ t(); passed++; } catch(e){ errors.push(e.message); } });
    console.debug(`[GmailSP] Self-tests passed: ${passed}/${tests.length}`, errors);
  }

  // ====== INIT ======
  async function init(){
    runSelfTests();
    await initSupa();
    if(!supa){ toast('กรุณาใส่ Anon Key เพื่อใช้ข้อมูลจริง'); return }
    updateChipbarSummary();
    await load(true);
  }
  document.addEventListener('DOMContentLoaded', init, { once:true });
  on($('#btnRefresh'),'click', async ()=>{ await load(true); toast('รีเฟรชแล้ว'); });

  </script>
</body>
</html>
